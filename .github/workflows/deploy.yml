name: Deploy WordPress to Azure App Service

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: wp-az-docker-template    # Reemplazar con el nombre de tu App Service
  AZURE_WEBAPP_PACKAGE_PATH: '.'
  NODE_VERSION: '18.x'
  PHP_VERSION: '8.2'

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ›’ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ˜ Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ env.PHP_VERSION }}
        extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, dom, filter, gd, json, mbstring, pdo, redis
        coverage: none

    - name: ğŸ“¦ Cache Composer packages
      uses: actions/cache@v3
      with:
        path: vendor
        key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-php-

    - name: ğŸ”§ Install Composer dependencies
      run: |
        if [ -f "composer.json" ]; then
          composer install --no-progress --no-suggest --no-interaction --prefer-dist --optimize-autoloader
        fi

    - name: ğŸ§ª Run PHP syntax check
      run: |
        find . -name "*.php" -not -path "./vendor/*" -exec php -l {} \;

  deploy-production:
    runs-on: ubuntu-latest
    needs: [build-and-test]
    if: github.ref == 'refs/heads/master'
    
    steps:
    - name: ğŸ›’ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ—ï¸ Build and push to GitHub Container Registry
      run: |
        echo ${{ secrets.GHCR_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
        docker build -t ghcr.io/${{ github.repository_owner }}/wp-az-docker-template:latest .
        docker build -t ghcr.io/${{ github.repository_owner }}/wp-az-docker-template:${{ github.sha }} .
        docker push ghcr.io/${{ github.repository_owner }}/wp-az-docker-template:latest
        docker push ghcr.io/${{ github.repository_owner }}/wp-az-docker-template:${{ github.sha }}

    - name: âœ… Container pushed successfully
      run: |
        echo "âœ… Container pushed to ghcr.io!"
        echo "ğŸ³ Image: ghcr.io/${{ github.repository_owner }}/wp-az-docker-template:latest"
        echo "ğŸ”„ Azure App Service will pull automatically"